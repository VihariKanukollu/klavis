worker_processes auto;
events { 
    worker_connections 1024; 
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;

    # Upstream blocks for all MCP services
    # CRM & Sales/RevOps
    upstream mcp_affinity { server mcp-affinity:5000; }
    upstream mcp_attio { server mcp-attio:5000; }
    upstream mcp_close { server mcp-close:5000; }
    upstream mcp_hubspot { server mcp-hubspot:5000; }
    upstream mcp_salesforce { server mcp-salesforce:5000; }
    upstream mcp_gong { server mcp-gong:5000; }

    # Project & Issue Tracking
    upstream mcp_asana { server mcp-asana:5000; }
    upstream mcp_clickup { server mcp-clickup:5000; }
    upstream mcp_jira { server mcp-jira:5000; }
    upstream mcp_linear { server mcp-linear:5000; }
    upstream mcp_monday { server mcp-monday:5000; }
    upstream mcp_motion { server mcp-motion:5000; }

    # Support & Helpdesk
    upstream mcp_freshdesk { server mcp-freshdesk:5000; }

    # Marketing & Outreach
    upstream mcp_mailchimp { server mcp-mailchimp:5000; }
    upstream mcp_resend { server mcp-resend:5000; }

    # Communication & Meetings
    upstream mcp_slack { server mcp-slack:5000; }
    upstream mcp_discord { server mcp-discord:5000; }
    upstream mcp_gmail { server mcp-gmail:5000; }
    upstream mcp_google_calendar { server mcp-google-calendar:5000; }
    upstream mcp_google_meet { server mcp-google-meet:5000; }
    upstream mcp_twilio { server mcp-twilio:5000; }
    upstream mcp_whatsapp { server mcp-whatsapp:5000; }
    upstream mcp_cal_com { server mcp-cal-com:5000; }

    # Files, Docs & Knowledge
    upstream mcp_confluence { server mcp-confluence:5000; }
    upstream mcp_notion { server mcp-notion:5000; }
    upstream mcp_google_docs { server mcp-google-docs:5000; }
    upstream mcp_google_sheets { server mcp-google-sheets:5000; }
    upstream mcp_google_slides { server mcp-google-slides:5000; }
    upstream mcp_google_drive { server mcp-google-drive:5000; }
    upstream mcp_dropbox { server mcp-dropbox:5000; }
    upstream mcp_onedrive { server mcp-onedrive:5000; }
    upstream mcp_wordpress { server mcp-wordpress:5000; }

    # Databases & Data Platforms
    upstream mcp_postgres { server mcp-postgres:5000; }
    upstream mcp_supabase { server mcp-supabase:5000; }
    upstream mcp_airtable { server mcp-airtable:5000; }

    # E-commerce, Payments & Finance
    upstream mcp_shopify { server mcp-shopify:5000; }
    upstream mcp_stripe { server mcp-stripe:5000; }
    upstream mcp_quickbooks { server mcp-quickbooks:5000; }
    upstream mcp_moneybird { server mcp-moneybird:5000; }
    upstream mcp_coinbase { server mcp-coinbase:5000; }

    # Developer Tools
    upstream mcp_github { server mcp-github:5000; }

    # Search, Research & Web Crawling
    upstream mcp_brave_search { server mcp-brave-search:5000; }
    upstream mcp_exa { server mcp-exa:5000; }
    upstream mcp_tavily { server mcp-tavily:5000; }
    upstream mcp_firecrawl { server mcp-firecrawl:5000; }
    upstream mcp_firecrawl_deep_research { server mcp-firecrawl-deep-research:5000; }
    upstream mcp_hacker_news { server mcp-hacker-news:5000; }

    # Social & Media
    upstream mcp_linkedin { server mcp-linkedin:5000; }
    upstream mcp_youtube { server mcp-youtube:5000; }
    upstream mcp_spotify { server mcp-spotify:5000; }

    # AI/LLM & Content Utilities
    upstream mcp_openrouter { server mcp-openrouter:5000; }
    upstream mcp_heygen { server mcp-heygen:5000; }
    upstream mcp_markitdown { server mcp-markitdown:5000; }
    upstream mcp_pandoc { server mcp-pandoc:5000; }
    upstream mcp_report_generation { server mcp-report-generation:5000; }
    upstream mcp_mem0 { server mcp-mem0:5000; }

    # Jobs & Recruiting
    upstream mcp_google_jobs { server mcp-google-jobs:5000; }

    # Analytics & BI
    upstream mcp_mixpanel { server mcp-mixpanel:5000; }

    # Map slug path to upstream
    map $uri $mcp_upstream {
        default "";
        
        # CRM & Sales/RevOps
        ~^/affinity/mcp/     mcp_affinity;
        ~^/attio/mcp/        mcp_attio;
        ~^/close/mcp/        mcp_close;
        ~^/hubspot/mcp/      mcp_hubspot;
        ~^/salesforce/mcp/   mcp_salesforce;
        ~^/gong/mcp/         mcp_gong;

        # Project & Issue Tracking
        ~^/asana/mcp/        mcp_asana;
        ~^/clickup/mcp/      mcp_clickup;
        ~^/jira/mcp/         mcp_jira;
        ~^/linear/mcp/       mcp_linear;
        ~^/monday/mcp/       mcp_monday;
        ~^/motion/mcp/       mcp_motion;

        # Support & Helpdesk
        ~^/freshdesk/mcp/    mcp_freshdesk;

        # Marketing & Outreach
        ~^/mailchimp/mcp/    mcp_mailchimp;
        ~^/resend/mcp/       mcp_resend;

        # Communication & Meetings
        ~^/slack/mcp/        mcp_slack;
        ~^/discord/mcp/      mcp_discord;
        ~^/gmail/mcp/        mcp_gmail;
        ~^/google_calendar/mcp/ mcp_google_calendar;
        ~^/google_meet/mcp/  mcp_google_meet;
        ~^/twilio/mcp/       mcp_twilio;
        ~^/whatsapp/mcp/     mcp_whatsapp;
        ~^/cal_com/mcp/      mcp_cal_com;

        # Files, Docs & Knowledge
        ~^/confluence/mcp/   mcp_confluence;
        ~^/notion/mcp/       mcp_notion;
        ~^/google_docs/mcp/  mcp_google_docs;
        ~^/google_sheets/mcp/ mcp_google_sheets;
        ~^/google_slides/mcp/ mcp_google_slides;
        ~^/google_drive/mcp/ mcp_google_drive;
        ~^/dropbox/mcp/      mcp_dropbox;
        ~^/onedrive/mcp/     mcp_onedrive;
        ~^/wordpress/mcp/    mcp_wordpress;

        # Databases & Data Platforms
        ~^/postgres/mcp/     mcp_postgres;
        ~^/supabase/mcp/     mcp_supabase;
        ~^/airtable/mcp/     mcp_airtable;

        # E-commerce, Payments & Finance
        ~^/shopify/mcp/      mcp_shopify;
        ~^/stripe/mcp/       mcp_stripe;
        ~^/quickbooks/mcp/   mcp_quickbooks;
        ~^/moneybird/mcp/    mcp_moneybird;
        ~^/coinbase/mcp/     mcp_coinbase;

        # Developer Tools
        ~^/github/mcp/       mcp_github;

        # Search, Research & Web Crawling
        ~^/brave_search/mcp/ mcp_brave_search;
        ~^/exa/mcp/          mcp_exa;
        ~^/tavily/mcp/       mcp_tavily;
        ~^/firecrawl/mcp/    mcp_firecrawl;
        ~^/firecrawl_deep_research/mcp/ mcp_firecrawl_deep_research;
        ~^/hacker_news/mcp/  mcp_hacker_news;

        # Social & Media
        ~^/linkedin/mcp/     mcp_linkedin;
        ~^/youtube/mcp/      mcp_youtube;
        ~^/spotify/mcp/      mcp_spotify;

        # AI/LLM & Content Utilities
        ~^/openrouter/mcp/   mcp_openrouter;
        ~^/heygen/mcp/       mcp_heygen;
        ~^/markitdown/mcp/   mcp_markitdown;
        ~^/pandoc/mcp/       mcp_pandoc;
        ~^/report_generation/mcp/ mcp_report_generation;
        ~^/mem0/mcp/         mcp_mem0;

        # Jobs & Recruiting
        ~^/google_jobs/mcp/  mcp_google_jobs;

        # Analytics & BI
        ~^/mixpanel/mcp/     mcp_mixpanel;
    }

    server {
        listen ${PORT:-8080};
        server_name _;

        # Health check
        location = /healthz {
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }

        # Route /<slug>/mcp/ to corresponding upstream
        location ~ ^/([a-z0-9_]+)/mcp/ {
            # Return 404 if slug not mapped
            if ($mcp_upstream = "") {
                return 404;
            }

            # Proxy headers for MCP StreamableHTTP
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";
            
            # Important for SSE/streaming
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 3600s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;

            # Forward to mapped upstream
            proxy_pass http://$mcp_upstream;
        }

        # Default 404 for unmatched paths
        location / {
            return 404 "MCP path not found";
        }
    }
}
